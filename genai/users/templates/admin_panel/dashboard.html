{% extends "base.html" %}
{% block title %}–ê–¥–º–∏–Ω–∫–∞{% endblock %}
{% block header_title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
  <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏</h3>

  <!-- ‚úÖ –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ -->
  <form id="createForm" style="margin-bottom: 1em;">
    <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏" required>
    <input type="text" name="provider" placeholder="–ü—Ä–æ–≤–∞–π–¥–µ—Ä" required>
    <input type="text" name="endpoint" placeholder="Endpoint URL" required>
    <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
  </form>

  <!-- üîÅ –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥–µ–ª–µ–π -->
  <ul style="padding: 0;">
    {% for model in models %}
      <li style="margin-bottom: 1em; list-style: none; background: #fff; padding: 1em; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <form onsubmit="updateModel(event, '{{ model.id }}')">
          <input type="text" name="name" value="{{ model.name }}" required>
          <input type="text" name="provider" value="{{ model.provider }}" required>
          <input type="text" name="endpoint" value="{{ model.endpoint }}" required>
          <label style="margin-left: 10px;">
            <input type="checkbox" name="is_active" {% if model.is_active %}checked{% endif %}>
            –ê–∫—Ç–∏–≤–Ω–∞
          </label>
          <button type="submit">üíæ</button>
          <button type="button" onclick="deleteModel('{{ model.id }}')">üóëÔ∏è</button>
        </form>
      </li>
    {% endfor %}
  </ul>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById("createForm").onsubmit = function(e) {
  e.preventDefault();
  const form = e.target;
  fetch("{% url 'admin_model_create' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({
      name: form.name.value,
      provider: form.provider.value,
      endpoint: form.endpoint.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) location.reload();
    else alert(data.error || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
  });
};

function updateModel(e, modelId) {
  e.preventDefault();
  const form = e.target;
  const is_active = form.is_active.checked;

  fetch(`/admin-panel/update-model/${modelId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({
      name: form.name.value,
      provider: form.provider.value,
      endpoint: form.endpoint.value,
      is_active
    })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) alert(data.error || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
  });
}

function deleteModel(modelId) {
  fetch(`/admin-panel/delete-model/${modelId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) location.reload();
    else alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
  });
}

function getCookie(name) {
  let value = "; " + document.cookie;
  let parts = value.split("; " + name + "=");
  if (parts.length === 2) return parts.pop().split(";").shift();
}
</script>
{% endblock %}
